<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmer-Led Irrigated Area Mapping – ASEAN</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; }
        #map { height: 75%; width: 100%; }
        .header, .footer { padding: 10px; text-align: center; background: #333; color: #fff; }
        .dropdown { margin: 0 5px; }
        #layerCheckbox { margin-right: 5px; }
		 .legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: white;
            padding: 10px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>Farmer-Led Irrigated Area Mapping – ASEAN</h1>
    <label><input type="checkbox" id="layerCheckbox"> FLID Suitable Area</label>
    <select id="countryDropdown" class="dropdown" onchange="loadAdminData();">
        <option value="">Select Country</option>
        <option value="KHM">Cambodia</option>
        <option value="LAO">Laos</option>
    </select>
    <select id="admin0Dropdown" class="dropdown" disabled><option>Select Admin0</option></select>
    <select id="admin1Dropdown" class="dropdown" disabled><option>Select Admin1</option></select>
    <select id="admin2Dropdown" class="dropdown" disabled><option>Select Admin2</option></select>
    <select id="admin3Dropdown" class="dropdown" disabled><option>Select Admin3</option></select>
    <button onclick="changeBaseMap('osm')">OSM</button>
    <button onclick="changeBaseMap('esri')">ESRI Satellite</button>
</div>

<div id="map"></div>

<div class="footer">
    © 2024 Farmer-Led Irrigated Area Mapping Project
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Initialize map and base layers
let map = L.map("map").setView([12.5657, 104.9910], 6);
let osmLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
let esriLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}");
let tileServerLayer = L.tileLayer('https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/Tile/{z}/{x}/{y}.png', {
    minZoom: 1, maxZoom: 11, tms: false, attribution: 'Generated by TilesXYZ'
});

// Define global variables to store layers for each administrative level
let admin0Layer, admin1Layer, admin2Layer, admin3Layer;
let previousLayer; // Store the previous selected layer
let selectedCountry = ''; // Store selected country

// Toggle FLID Suitable Area layer on checkbox toggle
document.getElementById("layerCheckbox").addEventListener("change", function () {
    if (this.checked) {
        tileServerLayer.addTo(map);
    } else {
        map.removeLayer(tileServerLayer);
    }
});

// Change basemap
function changeBaseMap(layer) {
    if (layer === "osm") {
        map.addLayer(osmLayer).removeLayer(esriLayer);
    } else {
        map.addLayer(esriLayer).removeLayer(osmLayer);
    }
}

// Load initial Admin0 data based on selected country
async function loadAdminData() {
    // Clear previous selections
    clearPreviousSelections();

    selectedCountry = document.getElementById("countryDropdown").value;

    let admin0GeoJSON;
    if (selectedCountry === 'KHM') {
        admin0GeoJSON = await fetch("https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/KHM/khm_admbnda_adm0_gov_20181004_FLID.geojson").then(res => res.json());
    } else if (selectedCountry === 'LAO') {
        admin0GeoJSON = await fetch("https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/LAO/lao_admbnda_adm0_ngd_20191112.geojson").then(res => res.json());
    }

    // Add admin0 layer to the map
    admin0Layer = L.geoJson(admin0GeoJSON, {
        style: {
            color: "blue", // Default color for unselected features
            weight: 1,
            fillOpacity: 0 // Transparent fill
        },
onEachFeature: function (feature, layer) {
    layer.on("click", function () {
        // Create a unique ID for the chart
        const chartId = 'chart-' + Math.random().toString(36).substr(2, 5);
        
        // Prepare the popup content
        const popupContent = `
            <div style="font-size: 9px;"> 
							
			    <strong>Country:</strong> ${feature.properties.ADM0_EN}<br>
                <strong>Provinces:</strong> ${feature.properties.ADM1_EN}<br>	
                <strong>Districts:</strong> ${feature.properties.ADM2_EN}<br>	
                <strong>Communes:</strong> ${feature.properties.ADM3_EN}<br>					
                <canvas id="${chartId}" width="200" height="200"></canvas>
            </div>
        `;
        
        // Bind the popup with chart canvas
        layer.bindPopup(popupContent).openPopup();

        // Create the pie chart using Chart.js
        const ctx = document.getElementById(chartId).getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Constraint', 'Unsuitable', 'Marginal', 'Moderate', 'Suitable', 'High'],
                datasets: [{
                    label: 'Attributes',
                    data: [feature.properties.VALUE_0, feature.properties.VALUE_20,feature.properties.VALUE_40, feature.properties.VALUE_60,feature.properties.VALUE_80, feature.properties.VALUE_100],
                    backgroundColor: ['rgba(200, 200, 200, 1)','rgba(156, 85, 31, 1)', 'rgba(207, 162, 99, 12)','rgba(255, 255, 191, 1)','rgba(145, 189, 169, 1)','rgba(34, 130, 145, 1)'],
                    borderColor: ['rgba(200, 200, 200, 1)','rgba(156, 85, 31, 1)', 'rgba(207, 162, 99, 12)','rgba(255, 255, 191, 1)','rgba(145, 189, 169, 1)','rgba(34, 130, 145, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
							            labels: {
											font: {
											size: 9 // Set legend font size here
													},
										boxWidth: 10, // Set the width of the color boxes in the legend
										padding: 10 // Add padding around the legend labels
												}							
                    },
                    title: {
                        display: true,
                        text: 'FLID Suitable Area '
                    }
                }
            }
        });
    });
}

    }).addTo(map);

    populateDropdown("admin0Dropdown", admin0GeoJSON, "ADM0_EN");
    document.getElementById("admin0Dropdown").disabled = false;
}

// Clear previous selections from the map and dropdowns
function clearPreviousSelections() {
    // Remove all admin layers from the map
    if (admin0Layer) map.removeLayer(admin0Layer);
    if (admin1Layer) map.removeLayer(admin1Layer);
    if (admin2Layer) map.removeLayer(admin2Layer);
    if (admin3Layer) map.removeLayer(admin3Layer);

    // Clear dropdowns
    document.getElementById("admin0Dropdown").innerHTML = `<option>Select Admin0</option>`;
    document.getElementById("admin1Dropdown").innerHTML = `<option>Select Admin1</option>`;
    document.getElementById("admin2Dropdown").innerHTML = `<option>Select Admin2</option>`;
    document.getElementById("admin3Dropdown").innerHTML = `<option>Select Admin3</option>`;

    // Disable dropdowns
    document.getElementById("admin1Dropdown").disabled = true;
    document.getElementById("admin2Dropdown").disabled = true;
    document.getElementById("admin3Dropdown").disabled = true;
}

// Populate dropdown with unique attribute values
function populateDropdown(dropdownId, geojsonData, attribute) {
    const dropdown = document.getElementById(dropdownId);
    dropdown.innerHTML = `<option>Select </option>`; // Reset dropdown
    const uniqueValues = [...new Set(geojsonData.features.map(feature => feature.properties[attribute]))];
    uniqueValues.forEach(value => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        dropdown.appendChild(option);
    });
}

// Update dropdown and manage layer replacement based on selection
async function updateDropdown(dropdownId, attribute, newLayerUrl, layerVariable, selectedValue) {
    const dropdown = document.getElementById(dropdownId);
    dropdown.innerHTML = `<option>Select </option>`;
    
    // Remove the previous layer from the map if it exists
    if (layerVariable && map.hasLayer(layerVariable)) {
        map.removeLayer(layerVariable);
    }

    // Fetch and filter new GeoJSON data
    const newGeoJSON = await fetch(newLayerUrl).then(res => res.json());
    const filteredGeoJSON = {
        ...newGeoJSON,
        features: newGeoJSON.features.filter(f => f.properties[attribute] === selectedValue)
    };

    // Add the new filtered layer to the map and update the global reference
    layerVariable = L.geoJson(filteredGeoJSON, {
        style: function(feature) {
            return {
                color: "blue", // Default color for unselected features
                weight: 1,
                fillOpacity: 0 // Transparent fill
            };
        },
onEachFeature: function (feature, layer) {
    layer.on("click", function () {
        // Create a unique ID for the chart
        const chartId = 'chart-' + Math.random().toString(36).substr(2, 5);
        
        // Prepare the popup content
        const popupContent = `
            <div style="font-size: 9px;"> 			
			    <strong>Country:</strong> ${feature.properties.ADM0_EN}<br>
                <strong>Provinces:</strong> ${feature.properties.ADM1_EN}<br>	
                <strong>Districts:</strong> ${feature.properties.ADM2_EN}<br>	
                <strong>Communes:</strong> ${feature.properties.ADM3_EN}<br>		
                <canvas id="${chartId}" width="200" height="200"></canvas>
            </div>
        `;
        
        // Bind the popup with chart canvas
        layer.bindPopup(popupContent).openPopup();

        // Create the pie chart using Chart.js
        const ctx = document.getElementById(chartId).getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Constraint', 'Unsuitable', 'Marginal', 'Moderate', 'Suitable', 'High'],
                datasets: [{
                    label: 'Attributes',
                    data: [feature.properties.VALUE_0, feature.properties.VALUE_20,feature.properties.VALUE_40, feature.properties.VALUE_60,feature.properties.VALUE_80, feature.properties.VALUE_100],
                    backgroundColor: ['rgba(200, 200, 200, 1)','rgba(156, 85, 31, 1)', 'rgba(207, 162, 99, 1)','rgba(255, 255, 191, 1)','rgba(145, 189, 169, 1)','rgba(34, 130, 145, 1)'],
                    borderColor: ['rgba(200, 200, 200, 1)','rgba(156, 85, 31, 1)', 'rgba(207, 162, 99, 12)','rgba(255, 255, 191, 1)','rgba(145, 189, 169, 1)','rgba(34, 130, 145, 1)'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
							            labels: {
											font: {
											size: 9 // Set legend font size here
													},
										boxWidth: 10, // Set the width of the color boxes in the legend
										padding: 10 // Add padding around the legend labels
												}							
                    },
                    title: {
                        display: true,
                        text: 'FLID Suitable Area'
                    }
                }
            }
        });
    });
}

    }).addTo(map);

    // Fit the map bounds to the new layer
    map.fitBounds(layerVariable.getBounds());

    // Populate the next dropdown with unique values from the new filtered data
    const nextAttribute = attribute === "ADM0_EN" ? "ADM1_EN" :
                          attribute === "ADM1_EN" ? "ADM2_EN" : "ADM3_EN";
    const uniqueValues = [...new Set(filteredGeoJSON.features.map(f => f.properties[nextAttribute]))];
    uniqueValues.forEach(value => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        dropdown.appendChild(option);
    });
    dropdown.disabled = false;

    // Reset previous layer styles
    if (previousLayer) {
        previousLayer.setStyle({ color: "blue", fillOpacity: 0 }); // Reset color for previous layers
    }
    
    // Set the current selection to red
    layerVariable.setStyle({ color: "red", fillOpacity: 0 }); // Set current selection to red

    previousLayer = layerVariable; // Update previous layer to the current one

    return layerVariable; // Return the newly created layer for further use
}


// Event listener for Admin0 dropdown selection
document.getElementById("admin0Dropdown").addEventListener("change", async function () {
    const selectedValue = this.value;
    let admin1Url = selectedCountry === 'KHM' 
        ? "https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/KHM/khm_admbnda_adm1_gov_20181004_FLID.geojson"
        : "https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/LAO/lao_admbnda_adm1_ngd_20191112.geojson";
    admin1Layer = await updateDropdown("admin1Dropdown", "ADM0_EN", admin1Url, admin1Layer, selectedValue);
});

// Event listener for Admin1 dropdown selection
document.getElementById("admin1Dropdown").addEventListener("change", async function () {
    const selectedValue = this.value;
    let admin2Url = selectedCountry === 'KHM' 
        ? "https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/KHM/khm_admbnda_adm2_gov_20181004_FLID.geojson"
        : "https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/LAO/lao_admbnda_adm2_ngd_20191112.geojson";
    admin2Layer = await updateDropdown("admin2Dropdown", "ADM1_EN", admin2Url, admin2Layer, selectedValue);
});

// Event listener for Admin2 dropdown selection
document.getElementById("admin2Dropdown").addEventListener("change", async function () {
    const selectedValue = this.value;
    let admin3Url = selectedCountry === 'KHM' 
        ? "https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/KHM/khm_admbnda_adm3_gov_20181004_FLID.geojson"
        : "https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/LAO/lao_admbnda_adm2_ngd_20191112.geojson";
    admin3Layer = await updateDropdown("admin3Dropdown", "ADM2_EN", admin3Url, admin3Layer, selectedValue);
});

// Event listener for Admin3 dropdown selection
// Event listener for Admin3 dropdown selection
document.getElementById("admin3Dropdown").addEventListener("change", function () {
    const selectedValue = this.value;

    if (admin3Layer && selectedValue) {
        // Reset the color of all features in admin3Layer to blue
        admin3Layer.eachLayer(function(layer) {
            layer.setStyle({
                color: "blue" // Reset color for all layers to blue
            });
        });

        // Find the selected feature from admin3Layer
        const selectedFeature = admin3Layer.getLayers().find(layer => {
            return layer.feature.properties.ADM3_EN === selectedValue; // Adjust this property as necessary
        });

        if (selectedFeature) {
            // Set the style of the selected feature to red
            selectedFeature.setStyle({
                color: "red" // Set color for selected feature to red
            });

            const bounds = selectedFeature.getBounds();
            map.fitBounds(bounds); // Zoom to the selected Admin3 feature

            // Extract Shape_Leng and Shape_Area from the selected feature
            const shapeLength = selectedFeature.feature.properties.Shape_Leng;
            const shapeArea = selectedFeature.feature.properties.Shape_Area;

            // Create the pie chart in the popup
            const popupContent = `
                <div style="font-size: 9px;"> 
			    <strong>Country:</strong> ${feature.properties.ADM0_EN}<br>
                <strong>Provinces:</strong> ${feature.properties.ADM1_EN}<br>	
                <strong>Districts:</strong> ${feature.properties.ADM2_EN}<br>	
                <strong>Communes:</strong> ${feature.properties.ADM3_EN}<br>					
                    <canvas id="myPieChart" width="200" height="200"></canvas>
                </div>
            `;

            // Create a popup and set its content
            L.popup()
                .setLatLng(bounds.getCenter())
                .setContent(popupContent)
                .openOn(map);

            // Wait for the popup to be added to the DOM before creating the chart
            setTimeout(() => {
                const ctx = document.getElementById('myPieChart').getContext('2d');
                const myPieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Constraint', 'Unsuitable', 'Marginal', 'Moderate', 'Suitable', 'High'],
                        datasets: [{
                            label: 'Area and Length',
                            data: [VALUE_0, VALUE_20,VALUE_40,VALUE_60,VALUE_80,VALUE_100],
                            backgroundColor: ['rgba(200, 200, 200, 1)','rgba(156, 85, 31, 1)', 'rgba(207, 162, 99, 1)','rgba(255, 255, 191, 1)','rgba(145, 189, 169, 1)','rgba(34, 130, 145, 1)'],
                            borderColor: ['rgba(200, 200, 200, 1)','rgba(156, 85, 31, 1)', 'rgba(207, 162, 99, 12)','rgba(255, 255, 191, 1)','rgba(145, 189, 169, 1)','rgba(34, 130, 145, 1)'],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom',
							            labels: {
											font: {
											size: 9 // Set legend font size here
													},
										boxWidth: 10, // Set the width of the color boxes in the legend
										padding: 10 // Add padding around the legend labels
												}	
                            },
                            title: {
                                display: true,
                                text: 'FLID Suitable Area'
								
                            }
                        }
                    }
                });
            }, 100); // Delay to ensure the popup is rendered before accessing the canvas
        }
    }
});

    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `<img src="https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/Legend.jpg" alt="Legend" style="width: 250px;">`;
        return div;
    };
    legend.addTo(map);

</script>

</body>
</html>

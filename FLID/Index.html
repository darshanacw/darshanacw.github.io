<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmer-Led Irrigated Area Mapping</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; }
        #map { height: 80vh; width: 100%; }
        header, footer { background-color: #f8f9fa; padding: 10px; text-align: center; font-size: 1.2em; }
        .dropdown, .checkbox { margin: 5px; }
        .legend { position: absolute; bottom: 10px; right: 10px; background-color: white; padding: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<header>
    <h2>Farmer-Led Irrigated Area Mapping</h2>
    <label class="checkbox">
        <input type="checkbox" id="tileServerCheckbox" checked onclick="toggleTileServer()"> FLID Suitability
    </label>
    <select id="countryDropdown" class="dropdown" onchange="updateDropdowns('ADM0_EN')">
        <option value="">Select Country</option>
    </select>
    <select id="adm1Dropdown" class="dropdown" onchange="updateDropdowns('ADM1_EN')">
        <option value="">Select ADM_1</option>
    </select>
    <select id="adm2Dropdown" class="dropdown" onchange="updateDropdowns('ADM2_EN')">
        <option value="">Select ADM_2</option>
    </select>
    <select id="adm3Dropdown" class="dropdown" onchange="zoomToSelected()">
        <option value="">Select ADM_3</option>
    </select>
</header>

<div id="map"></div>

<footer>
    <p></p>
</footer>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // Initialize the map with the default view
    const map = L.map('map').setView([12.0, 105.0], 6.5);

    // Tile server layer with maxZoom set to 10
    const tileServerLayer = L.tileLayer('https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/Tile/{z}/{x}/{y}.png', {
        minZoom: 1,
        maxZoom: 11,
        tms: false,
        attribution: 'Generated by TilesXYZ'
    }).addTo(map);

    // Base layer options with maxZoom set to 10
    const baseLayers = {
        "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 11,
            attribution: '&copy; OpenStreetMap contributors'
        }),
        "ESRI Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{x}/{y}', {
            maxZoom: 11,
            attribution: 'Tiles &copy; Esri'
        })
    };

    L.control.layers(baseLayers).addTo(map);

    // Function to toggle tile server layer
    function toggleTileServer() {
        const checkbox = document.getElementById("tileServerCheckbox");
        if (checkbox.checked) {
            map.addLayer(tileServerLayer);
        } else {
            map.removeLayer(tileServerLayer);
        }
    }

    // Variables to store GeoJSON data and map layers
    let geoJsonData;
    let geoJsonLayer;
    let selectedLayer;

    // Style for GeoJSON features
    const defaultStyle = {
        color: "#0000FF",
        weight: 0.5,
        fillOpacity: 0
    };

    const highlightStyle = {
        color: "red",
        weight: 2,
        fillOpacity: 0
    };

    // Load GeoJSON data and populate dropdowns
    fetch('https://raw.githubusercontent.com/darshanacw/darshanacw.github.io/main/FLID/khm_admbnda_adm3_gov_20181004.geojson')
        .then(response => response.json())
        .then(data => {
            geoJsonData = data;
            geoJsonLayer = L.geoJSON(geoJsonData, {
                style: defaultStyle,
                onEachFeature: function (feature, layer) {
                    layer.on('click', () => zoomToFeature(layer));
                }
            }).addTo(map);
            populateDropdowns();
        });

    // Populate initial dropdowns with unique values from GeoJSON properties
    function populateDropdowns() {
        const countries = new Set();
        geoJsonData.features.forEach(feature => countries.add(feature.properties.ADM0_EN));
        addOptionsToDropdown("countryDropdown", Array.from(countries));
    }

    // Add options to a dropdown
    function addOptionsToDropdown(dropdownId, options) {
        const dropdown = document.getElementById(dropdownId);
        dropdown.innerHTML = `<option value="">Select ${dropdownId.split('Dropdown')[0].toUpperCase()}</option>`;
        options.sort().forEach(value => {
            const option = document.createElement("option");
            option.value = value;
            option.text = value;
            dropdown.appendChild(option);
        });
    }

    // Update dropdowns based on selected values and zoom to feature
    function updateDropdowns(level) {
        const selectedCountry = document.getElementById("countryDropdown").value;
        const selectedAdm1 = document.getElementById("adm1Dropdown").value;
        const selectedAdm2 = document.getElementById("adm2Dropdown").value;

        let filteredFeatures = geoJsonData.features;

        if (selectedCountry) filteredFeatures = filteredFeatures.filter(f => f.properties.ADM0_EN === selectedCountry);
        if (selectedAdm1) filteredFeatures = filteredFeatures.filter(f => f.properties.ADM1_EN === selectedAdm1);
        if (selectedAdm2) filteredFeatures = filteredFeatures.filter(f => f.properties.ADM2_EN === selectedAdm2);

        if (level === "ADM0_EN") {
            const adm1s = new Set(filteredFeatures.map(f => f.properties.ADM1_EN));
            addOptionsToDropdown("adm1Dropdown", Array.from(adm1s));
            document.getElementById("adm2Dropdown").innerHTML = `<option value="">Select ADM_2</option>`;
            document.getElementById("adm3Dropdown").innerHTML = `<option value="">Select ADM_3</option>`;
        } else if (level === "ADM1_EN") {
            const adm2s = new Set(filteredFeatures.map(f => f.properties.ADM2_EN));
            addOptionsToDropdown("adm2Dropdown", Array.from(adm2s));
            document.getElementById("adm3Dropdown").innerHTML = `<option value="">Select ADM_3</option>`;
        } else if (level === "ADM2_EN") {
            const adm3s = new Set(filteredFeatures.map(f => f.properties.ADM3_EN));
            addOptionsToDropdown("adm3Dropdown", Array.from(adm3s));
        }

        if (filteredFeatures.length > 0) {
            const tempLayer = L.geoJSON(filteredFeatures).addTo(map);
            map.fitBounds(tempLayer.getBounds());
            map.removeLayer(tempLayer);
        }
    }

    // Zoom to selected feature in the ADM_3 dropdown
    function zoomToSelected() {
        const selectedAdm3 = document.getElementById("adm3Dropdown").value;
        const selectedFeature = geoJsonData.features.find(f => f.properties.ADM3_EN === selectedAdm3);
        
        if (selectedLayer) geoJsonLayer.resetStyle(selectedLayer);
        
        if (selectedFeature) {
            selectedLayer = L.geoJSON(selectedFeature, { style: highlightStyle }).addTo(map);
            map.fitBounds(selectedLayer.getBounds());
        }
    }

    // Zoom to a specific layer/feature
    function zoomToFeature(layer) {
        if (selectedLayer) geoJsonLayer.resetStyle(selectedLayer);
        selectedLayer = layer;
        layer.setStyle(highlightStyle);
        map.fitBounds(layer.getBounds());
    }

    // Add a legend to the map
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = '<img src="https://github.com/darshanacw/darshanacw.github.io/raw/main/FLID/Legend.jpg" alt="Legend" style="width: 150px;">';
        return div;
    };
    legend.addTo(map);
</script>

</body>
</html>
